# =====================================================
# RGBW Controller (4 Kan√§le: R, G, B, W)
# ESPHome RGBWW Controller - RGBW Variant
# Version: 2.0 - Working with proper color_mode control
# =====================================================

esphome:
  name: rgbw-controller
  comment: "RGBW LED Controller - 4 Channel with RGB and White"
  project:
    name: vr6syncro.esphome-rgbww-controller
    version: "2.0-rgbw"

preferences:
  flash_write_interval: 30s

esp8266:
  board: esp12e
  restore_from_flash: true

logger:
  level: INFO

api:
  encryption:
    key: !secret api_encryption_key
  reboot_timeout: 0s

ota:
  platform: esphome
  password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: none

captive_portal:

status_led:
  pin: GPIO2

# ---------------------
# Outputs
# ---------------------
output:
  - platform: esp8266_pwm
    id: out_red
    pin: GPIO13
    frequency: 1200 Hz
  - platform: esp8266_pwm
    id: out_green
    pin: GPIO12
    frequency: 1200 Hz
  - platform: esp8266_pwm
    id: out_blue
    pin: GPIO14
    frequency: 1200 Hz
  - platform: esp8266_pwm
    id: out_white
    pin: GPIO5
    frequency: 1200 Hz

# ---------------------
# Main Light
# ---------------------
light:
  - platform: rgbw
    name: "RGBW Strip"
    id: rgbw_light
    red: out_red
    green: out_green
    blue: out_blue
    white: out_white
    gamma_correct: 2.8
    default_transition_length: 800ms
    color_interlock: true  # Either RGB or White
    restore_mode: RESTORE_DEFAULT_OFF
    effects:
      - pulse:
          name: "Soft Pulse"
          transition_length: 1.5s
      - random:
          name: "Random Colors"
          transition_length: 2s
      - flicker:
          name: "Candle"
          alpha: 95%
          intensity: 1.5%

# ---------------------
# Presets / Scenes
# ---------------------
button:
  # --- RGB COLORS ---
  - platform: template
    id: preset_red
    name: "Preset: Red"
    icon: mdi:palette
    on_press:
      - light.control:
          id: rgbw_light
          color_mode: RGB
          brightness: !lambda return id(rgbw_light).current_values.get_brightness();
          red: 100%
          green: 0%
          blue: 0%

  - platform: template
    id: preset_green
    name: "Preset: Green"
    icon: mdi:palette
    on_press:
      - light.control:
          id: rgbw_light
          color_mode: RGB
          brightness: !lambda return id(rgbw_light).current_values.get_brightness();
          red: 0%
          green: 100%
          blue: 0%

  - platform: template
    id: preset_blue
    name: "Preset: Blue"
    icon: mdi:palette
    on_press:
      - light.control:
          id: rgbw_light
          color_mode: RGB
          brightness: !lambda return id(rgbw_light).current_values.get_brightness();
          red: 0%
          green: 0%
          blue: 100%

  - platform: template
    id: preset_yellow
    name: "Preset: Yellow"
    icon: mdi:palette
    on_press:
      - light.control:
          id: rgbw_light
          color_mode: RGB
          brightness: !lambda return id(rgbw_light).current_values.get_brightness();
          red: 100%
          green: 100%
          blue: 0%

  - platform: template
    id: preset_cyan
    name: "Preset: Cyan"
    icon: mdi:palette
    on_press:
      - light.control:
          id: rgbw_light
          color_mode: RGB
          brightness: !lambda return id(rgbw_light).current_values.get_brightness();
          red: 0%
          green: 100%
          blue: 100%

  - platform: template
    id: preset_purple
    name: "Preset: Purple"
    icon: mdi:palette
    on_press:
      - light.control:
          id: rgbw_light
          color_mode: RGB
          brightness: !lambda return id(rgbw_light).current_values.get_brightness();
          red: 100%
          green: 0%
          blue: 100%

  # --- WHITE CHANNEL ---
  - platform: template
    id: preset_pure_white
    name: "Preset: Pure White"
    icon: mdi:lightbulb-on
    on_press:
      - light.control:
          id: rgbw_light
          color_mode: WHITE
          white: 100%
          brightness: !lambda return id(rgbw_light).current_values.get_brightness();

  - platform: template
    id: preset_pure_white_50
    name: "Preset: Pure White 50%"
    icon: mdi:lightbulb-on-outline
    on_press:
      - light.control:
          id: rgbw_light
          color_mode: WHITE
          white: 100%
          brightness: 50%

  # --- MIXED COLORS (RGB + White) ---
  - platform: template
    id: preset_warm_cool_mix
    name: "Preset: Warm Cool Mix"
    icon: mdi:lightbulb-variant
    on_press:
      - light.control:
          id: rgbw_light
          brightness: !lambda return id(rgbw_light).current_values.get_brightness();
          red: 80%
          green: 60%
          blue: 40%
          white: 30%

  # --- SCENES ---
  - platform: template
    id: preset_relax
    name: "Preset: Relax"
    icon: mdi:sofa
    on_press:
      - light.control:
          id: rgbw_light
          color_mode: WHITE
          white: 100%
          brightness: 30%
          transition_length: 3s

  - platform: template
    id: preset_night_light
    name: "Preset: Night Light"
    icon: mdi:weather-night
    on_press:
      - light.control:
          id: rgbw_light
          color_mode: WHITE
          white: 100%
          brightness: 5%

  - platform: template
    id: preset_candle
    name: "Preset: Candle"
    icon: mdi:candle
    on_press:
      - light.control:
          id: rgbw_light
          effect: Candle
          color_mode: RGB
          brightness: !lambda return id(rgbw_light).current_values.get_brightness();
          red: 100%
          green: 60%
          blue: 10%

  # --- System ---
  - platform: safe_mode
    name: "Safe Mode"

  - platform: factory_reset
    name: "Factory Reset"

  - platform: restart
    id: restart_controller
    name: "Restart Controller"

# ---------------------
# Sensors
# ---------------------
sensor:
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s
  - platform: uptime
    name: "Uptime"

binary_sensor:
  - platform: status
    name: "Online"

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "IP Address"
    ssid:
      name: "SSID"
    mac_address:
      name: "MAC"